<html>

<head>
    <title>Twitts Viz with socket.io and node.js</title>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css">

     <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">


    <style>
                .items-collection label.btn-default.active {
            background-color: #007ba7;
            color: #FFF;
        }

        .items-collection1 label.btn-default {
            width: 10%;
            border: 1px solid #305891;
            margin: 0;
            padding-right: 0px;
            border-radius: 17px;
            color: #305891;
            opacity: 0.5
        }

        .items-collection label .itemcontent {
            width: 100%;
        }

        .items-collection .btn-group {
            width: 100%;
            padding-left: 45px
        }



        #contentWrap {
            width: 60%;
            margin-left: 50px;
            background-color: rgba(52, 152, 219, 0);
        }

        #chat {
            background-color: rgba(52, 152, 219, 0.2);
            height: 100px;
            /*width: 100%;*/
            overflow: scroll;
            margin-bottom: 0px;
            margin-left: 0px;
        }

        #chatWrap {
            float: left;
            width: 100%;
            border: 10px #000 solid;
        }

        #trend {
            float: right;
        }

        .error {
            color: red;
        }

        #test {
            background-color: rgba(52, 152, 219, 0.2);
            color: black;
            position: fixed;
            top: 500px;
            right: 20px;
        }

        #pie {
            position: absolute;
            left: 20px;
            top: 130px;
        }

        #line {
            position: absolute;
            left: 20px;
            top: 350px;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 70%;
            /*            z-index: -1;*/
        }

        .msg {
            border: 0px solid #3498DB;
            border-radius: 5px;
            color: #fff;
            background-color: rgba(52, 152, 219, 0);
            top: 20px;
            margin-left: 0;
            margin-right: auto;
            left: 0;
            right: 0;
        }

        #keys {
            border: 0px solid #3498DB;
            border-radius: 5px;
            color: #fff;
            background-color: rgba(52, 152, 219, 0.2);
            top: 20px;
            margin-left: auto;
            margin-right: auto;
            left: 0;
            right: 0;
        }
<<<<<<< Updated upstream

        .search {
            padding: 5px 0;
            width: 230px;
            height: 30px;
            position: relative;
            left: 10px;
            float: left;
            line-height: 22px;
        }

        .search input {
            position: absolute;
            width: 0px;
            float: Left;
            margin-left: 210px;
            -webkit-transition: all 0.7s ease-in-out;
            -moz-transition: all 0.7s ease-in-out;
            -o-transition: all 0.7s ease-in-out;
            transition: all 0.7s ease-in-out;
            height: 30px;
            line-height: 18px;
            padding: 0 2px 0 2px;
            border-radius: 1px;
        }

        .search:hover input,
        .search input:focus {
            width: 200px;
            margin-left: 0px;
        }

=======
        

        
>>>>>>> Stashed changes
        .btn {
            height: 30px;
            position: absolute;
            right: 0;
            top: 5px;
            border-radius: 1px;
        }

        .topList {
          background-color: white;
          font-size: 1.2em;
          color: black;
          list-style-position: inside;
          /*padding: 10px;*/
        }
        .ListTitle {
          font-size: 1.5em;
        }
    </style>
</head>

<body>
    <canvas id="pie" width="200" height="200"></canvas>
    <canvas id="line" width="350" height="300"></canvas>

    <div id='map'></div>
    <div style="position: absolute; right: 0; width: 30%;">
      <div class="ListTitle">Top 10 Hashtag</div>
      <ol id="hashTopList" class="topList"></ol>
      <div class="ListTitle">Top 10 Mention</div>
      <ol id="mentionTopList" class="topList"></ol>
    </div>
    <div class="row">
        <div class="small-6 columns small-centered">
            <div class="alert alert-info" id="chat"><span>Real-Time Tweets</span>
            </div>
        </div>

              <div class="row">
            <div class="form-group">
                <div class="items-collection" id="message1">
                    <div class="items-collection1">
                        <!--                <div class="items">-->
                        <!--                    <div class="info-block block-info clearfix">-->
                        <div data-toggle="buttons" class="btn-group ">
                            <label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3 " id="1">
                                <div class="itemcontent">
                                    <input type="radio" name="options" id="option1" autocomplete="off">Hashtop1

                                </div>
                            </label>

                            <label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3" id="2">
                                <div class="itemcontent">
                                    <input type="radio" name="options" id="option2" autocomplete="off">top2

                                </div>
                            </label>

                            <label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3" id="3">
                                <div class="itemcontent">
                                    <input type="radio" name="options" id="option3" autocomplete="off">top3

                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="test">
            <form id="wordTrend">
               

                <div id="keyError"></div>
            </form>
            <div id="keys"></div>
        </div>

        <div id="trend"></div>


        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            jQuery(function ($) {
                var socket = io.connect();
                var $lists = $('#keys');
                var $chat = $('#chat');
                var $keyForm = $('#wordTrend');
                var $keyBox = $('#chosenKey');
                var $keyError = $('#keyError');
                var $trend = $('#trend');
                var number = new Array(5);
                var topic = new Array(5);
                var iterator = 0;
                var topKey = new Map();

                var hashRank = []; //descending sorted array with every element like [key, value] (sorted by value)
                var mentionRank = []; //descending sorted array ...
                var lastHashData = new Map(); // [key,value] value is set of coords
                var lastMentionData = new Map();
                var hashTop = [];
                var mentionTop = [];
                var restKeyword = [];

                socket.on('past data', function (data) {
                    var hashRankNsort = {};
                    var mentionRankNsort = {};
                    lastHashData.clear();
                    lastMentionData.clear();

                    for (var i = 0; i < data.length; i++) {
                        var property = data[i].properties.keyword;
                        if (data[i].properties.type == "mention") {
                            if (mentionRankNsort[property] === undefined) {
                                mentionRankNsort[property] = 1;
                            } else {
                                mentionRankNsort[property]++;
                            }
                            //map
                            var locs = [];
                            if (lastMentionData.has(property)) {
                                locs = lastMentionData.get(property);
                            }
                            locs.push(data[i].geometry.coordinates);
                            lastMentionData.set(property, locs);
                        } else {
                            if (hashRankNsort[property] === undefined) {
                                hashRankNsort[property] = 1;
                            } else {
                                hashRankNsort[property]++;
                            }
                            //map
                            var locs = [];
                            if (lastHashData.has(property)) {
                                locs = lastHashData.get(property);
                            }
                            locs.push(data[i].geometry.coordinates);
                            lastHashData.set(property, locs)
                        }
                    }
                    hashRank = [];
                    mentionRank = [];
                    for (var key in hashRankNsort) {
                        hashRank.push([key, hashRankNsort[key]]);
                    }
                    hashRank.sort(function (a, b) {
                        return b[1] - a[1]
                    });

                    for (var key in mentionRankNsort) {
                        mentionRank.push([key, mentionRankNsort[key]]);
                    }
                    mentionRank.sort(function (a, b) {
                        return b[1] - a[1]
                    });
                    hashTop[0] = [];
                    hashTop[1] = [];
                    hashTop[2] = [];
                    hashTop[3] = [];
                    hashTop[4] = [];
                    hashTop[5] = [];
                    hashTop[6] = [];
                    hashTop[7] = [];
                    hashTop[8] = [];
                    hashTop[9] = [];
                    mentionTop[0] = [];
                    mentionTop[1] = [];
                    mentionTop[2] = [];
                    mentionTop[3] = [];
                    mentionTop[4] = [];
                    mentionTop[5] = [];
                    mentionTop[6] = [];
                    mentionTop[7] = [];
                    mentionTop[8] = [];
                    mentionTop[9] = [];
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].properties.keyword == hashRank[0][0]) { //1st hash
                            hashTop[0].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[1][0]) { //2nd
                            hashTop[1].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[2][0]) { //3rd
                            hashTop[2].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[3][0]) { //4th
                            hashTop[3].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[4][0]) { //5th
                            hashTop[4].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[5][0]) { //5th
                            hashTop[5].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[6][0]) { //5th
                            hashTop[6].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[7][0]) { //5th
                            hashTop[7].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[8][0]) { //5th
                            hashTop[8].push(data[i]);
                        } else if (data[i].properties.keyword == hashRank[9][0]) { //5th
                            hashTop[9].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[0][0]) { //1st mention
                            mentionTop[0].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[1][0]) { //2nd
                            mentionTop[1].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[2][0]) { //3rd
                            mentionTop[2].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[3][0]) { //4th
                            mentionTop[3].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[4][0]) { //5th
                            mentionTop[4].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[5][0]) { //5th
                            mentionTop[5].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[6][0]) { //5th
                            mentionTop[6].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[7][0]) { //5th
                            mentionTop[7].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[8][0]) { //5th
                            mentionTop[8].push(data[i]);
                        } else if (data[i].properties.keyword == mentionRank[9][0]) { //5th
                            mentionTop[9].push(data[i]);
                        } else {
                            restKeyword.push(data[i]);
                        }
                    }

                    var ul = document.getElementById("hashTopList");
                    if(ul.childNodes.length == 0){
                      for(var i = 0; i < hashTop.length; i ++){
                        li = document.createElement("li");
                        ul.appendChild(li);
                      }
                    }
                    for(var i = 0; i < hashTop.length; i ++){
                      var li = ul.childNodes[i];
                      li.innerText = hashTop[i][0].properties.keyword + ' : ' + hashTop[i].length;

                    }

                    var ul = document.getElementById("mentionTopList");
                    if(ul.childNodes.length == 0){
                      for(var i = 0; i < mentionTop.length; i ++){
                        li = document.createElement("li");
                        ul.appendChild(li);
                      }
                    }
                    for(var i = 0; i < mentionTop.length; i ++){
                      var li = ul.childNodes[i];
                      li.innerText = mentionTop[i][0].properties.keyword + ' : ' + mentionTop[i].length;

                    }
                    console.log(manageLastData(hashTop[0]));
                                       console.log(hashTop);
                                       console.log(mentionTop);
                    // console.log(lastHashData);
                });

                socket.on('keyword sorted list', function (data) {
                    var html = '';
                    for (var n = 0; n < 5; n++) {
                        number[n] = data[n].count;
                    }
                    topKey.clear();
                    for (var n = 0; n < 3; n++) {
                        topKey.set(data[n]._id, 1);
                    }

                    for (var t = 0; t < 5; t++) {
                        topic[t] = data[t]._id;
                    }
                    for (var i = 0; i < data.length; i++) {
                        html += data[i]._id + ' ' + data[i].count + '<br/>'
                    }
                    $lists.html(html);

                });

                var tweets_temp = []; // Records data for real-time tweets
                var map;
                var point_count = 0;
                var animation = [[1, 1], [30, 1], [100, 0.5], [300, 0]];
                //                        mapboxgl.accessToken = 'pk.eyJ1Ijoid2Vpc2hpIiwiYSI6ImNpbmc5cHV4bzFnOHJ1Zmx3ZGxpaGU0aGIifQ.L20RZ709ePgurmOeOYPwXg';
                //                        map = new mapboxgl.Map({
                //                            container: 'map'
                //                            , style: 'mapbox://styles/mapbox/dark-v8'
                //                            , center: [-73.961425, 40.786338]
                //                            , zoom: 11.7
                //                        });

                $(document).ready(function () {


                    mapboxgl.accessToken = 'pk.eyJ1Ijoid2Vpc2hpIiwiYSI6ImNpbmc5cHV4bzFnOHJ1Zmx3ZGxpaGU0aGIifQ.L20RZ709ePgurmOeOYPwXg';
                    map = new mapboxgl.Map({
                        container: 'map'
                        , style: 'mapbox://styles/mapbox/dark-v8'
                        , center: [-73.961425, 40.786338]
                        , zoom: 11.7
                    });
                    //here you try to ask the user position then setView to map

                    map.on('style.load', function () {
                        registerTempLayer("marker_temp", "lightblue");
                        registerLayer("marker_all", "#c84337", false, 0.9);
                        registerLayer("marker_2", "#ca7f35", false, 0.9);
                        registerLayer("marker_3", "#d9be26", false, 0.9);
                        registerLayer("marker_4", "#5ece31", false, 0.8);
                        registerLayer("marker_5", "#3cc382", false, 0.8);
                        registerLayer("marker_6", "#3f88bf", false, 0.8);
                        registerLayer("marker_7", "#554fb0", false, 0.8);
                        registerLayer("marker_8", "#5988a6", false, 0.8);
                        registerLayer("marker_9", "#7c837d", false, 0.8);
                        registerLayer("marker_10", "#FFF", false, 0.8);
//                        registerLayer("restword", "white", false, 0.1);
                    });
                });




                socket.on('new tweets', function (data) {
                    displayMsg(data);
                    //                    var tweet = manageTweet(data);
                    //                    console.log(tweet);
                    showPoint(data);

                });


                function manageTweet(tweet) {
                    return {
                        "type": "Feature"
                        , "geometry": {
                            "type": "Point"
                            , "coordinates": tweet.coord
                        }
                        , "properties": {
                            "text": tweet.text
                        }
                    }
                }

                function manageTweets(tweets) {
                    //                    console.log(tweets)
                    var points = tweets.map(function (tweet) {
                            return manageTweet(tweet);

                        })
                        //                    console.log(points);
                    points = {
                            "type": "FeatureCollection"
                            , "features": points
                        }
                        //                                            console.log(points);
                    return points;
                }


                function manageLastData(tweets) {
                    var points = {
                        "type": "FeatureCollection"
                        , "features": tweets
                    }
                    return points;
                }

                function registerLayer(name, color, docluster, opacity) {
                    map.addSource(name, {
                        "type": "geojson"
                        , "data": manageLastData([])
                        , cluster: docluster
                        , clusterMaxZoom: 40, // Max zoom to cluster points on
                        clusterRadius: 50
                    });
                                        map.addLayer({
                                            "id": name, // "interactive": true,
                                            "type": "circle"
                                            , "source": name
                                            , "paint": {
                                                "circle-color": color
                                                , "circle-radius": 2
                                                , "circle-opacity": opacity
                                            }
                                        });
//                    map.addLayer({
//                        "id": name, // "interactive": true,
//                        "type": "symbol"
//                        , "source": name, //        "paint": {
                        //            "circle-color": color,
                        //            "circle-radius": 1,
                        //            "circle-opacity": 1
                        //        }
//                        "layout": {
//                            //"icon-image": "",
//                            "icon-allow-overlap": false
//                            , "text-field": "{keyword}"
//                            , "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"]
//                            , "text-size": 9
//                            , "text-transform": "uppercase"
//                            , "text-letter-spacing": 0.05
//                            , "text-offset": [0, 1.5]
//                        }
//                        , "paint": {
//                            "text-color": "#202"
//                            , "text-halo-color": color
//                            , "text-halo-width": 2
//
//                        }
//                    });
                }

                function showPoints(tweets) {
                    //                                hideLayer("marker_temp");
                    ChangeLayerLastData("marker_all", tweets);
                }

                function hideLayer(layer) {
                    ChangeLayerLastData(layer, []);
                }


                function showPoint(tweet) {
                    tweets_temp.push(tweet);
                    //                    console.log(tweets_temp);
                    ChangeLayerData("marker_temp", tweets_temp);
                    var cur_point = "marker_point" + point_count;
                    ++point_count;
                    registerTempLayer(cur_point, "lightblue");
                    ChangeLayerData(cur_point, [tweet]);
                    animatePoint(cur_point, Date.now());
                }

                function animatePoint(id, start_time) {
                    var cur_frame = Math.floor((Date.now() - start_time) / 200);
                    if (cur_frame <= 3) {
                        map.setPaintProperty(id, "circle-radius", animation[cur_frame][0]);
                        map.setPaintProperty(id, "circle-opacity", animation[cur_frame][1]);
                        requestAnimationFrame(function () {
                            animatePoint(id, start_time);
                        });
                    } else {
                        map.removeSource(id);
                        map.removeLayer(id);
                    }
                }

                function registerTempLayer(name, color) {
                    map.addSource(name, {
                        "type": "geojson"
                        , "data": manageTweets([])
                    });
                    map.addLayer({
                        "id": name, // "interactive": true,
                        "type": "circle"
                        , "source": name
                        , "paint": {
                            "circle-color": color
                            , "circle-radius": 1
                            , "circle-opacity": 0.1
                        }
                    });
                }

                function ChangeLayerLastData(layer, tweets) {
                    tweets = manageLastData(tweets);
                    map.getSource(layer).setData(tweets);
                }

                function ChangeLayerData(layer, tweets) {
                    tweets = manageTweets(tweets);
                    //                                        console.log(tweets);
                    map.getSource(layer).setData(tweets);
                }

                function refreshKeylist() {
                    socket.emit('update keyword list');
                }


                function refreshPastData() {
                    socket.emit('past data');
                }
                var refreshId = setInterval(refreshPastData, 180000);
                //var refreshLineId = setInterval(refreshLineChart, 50000);
                //refreshKeylist();

                function sendTrendRequest(key) {
                    socket.emit('keyword trend', $keyBox.val(), function (data) {
                        if (data) {
                            $keyError.html('<font color=red>No result. Try again@!</font>');
                        }
                    });
                }

                $keyForm.submit(function (e) {
                    e.preventDefault();
                    sendTrendRequest($keyBox.val());
                });

                var lineTopDataMap = new Map();
                var lineExtraDataKey;
                var lineExtraDataResult;

                socket.on('keyword trend', function (data) {
                    if (topKey.has(data.key)) {
                        lineTopDataMap.set(data.key, data.result);
                    } else {
                        lineExtraDataKey = data.key;
                        lineExtraDataResult = data.result;
                    }
                    var datasets = new Array();
                    var dataset = {
                        key: lineExtraDataKey
                        , result: lineExtraDataResult
                    }
                    var cnt = 0;
                    datasets[cnt++] = dataset;
                    for (let [key, value] of lineTopDataMap.entries()) {
                        var dataset = {
                            key: key
                            , result: value
                        }
                        datasets[cnt++] = dataset;
                    }

                });






                function displayMsg(data) {
                    $chat.append('<span class="msg"><b>' + data.user + ': </b>' + data.text + ' ' + "</span><br/>");
                    $chat.scrollTop($chat[0].scrollHeight);
                    showPoints(hashTop[0]);
                    ChangeLayerLastData("marker_2", hashTop[1]);
                    ChangeLayerLastData("marker_3", hashTop[2]);
                    ChangeLayerLastData("marker_4", hashTop[3]);
                    ChangeLayerLastData("marker_5", hashTop[4]);
                    ChangeLayerLastData("marker_6", hashTop[5]);
                    ChangeLayerLastData("marker_7", hashTop[6]);
                    ChangeLayerLastData("marker_8", hashTop[7]);
                    ChangeLayerLastData("marker_9", hashTop[8]);
                    ChangeLayerLastData("marker_10", hashTop[9]);
                    console.log(hashTop[7]);
//                    ChangeLayerLastData("restword", restKeyword);

//                        var layers = [
//        [150, '#FFF'],
//        [20, '#FFF'],
//        [0, '#FFF']
//    ];
//
//    layers.forEach(function (layer, i) {
//        map.addLayer({
//            "id": "cluster-" + i,
//            "type": "circle",
//            "source": "restword",
//            "paint": {
//                "circle-color": layer[1],
//                "circle-radius": 2,
//                "circle-opacity": 0.1
//            },
//            "filter": i == 0 ?
//                [">=", "point_count", layer[0]] :
//                ["all",
//                    [">=", "point_count", layer[0]],
//                    ["<", "point_count", layers[i - 1][0]]]
//        });
//    });

    // Add a layer for the clusters' count labels
//    map.addLayer({
//        "id": "cluster-count",
//        "type": "symbol",
//        "source": "restword",
//        "layout": {
//            "text-field": "{point_count}",
//            "text-font": [
//                    "DIN Offc Pro Medium",
//                    "Arial Unicode MS Bold"
//                ],
//            "text-size": 6
//        }
//    });

                }
 $("#message1 label.btn").on("click", function () {
     console.log($(this).attr('id'));
     if($(this).attr('id') == 1) {
             hideLayer("marker_3");
            hideLayer("marker_2");
//             hideLayer("restword");
         }
         if($(this).attr('id') == 2) {
             hideLayer("marker_3");
            hideLayer("marker_all");
//             hideLayer("restword");
         }

        //        message += $(this).attr('id');
        //        console.log(message);
    });

            });
        </script>
</body>

</html>
