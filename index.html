<html>
<head>
    <title>Twitts Viz with socket.io and node.js</title>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

    <style>
        .items-collection label.btn-default.active {
            background-color: #007ba7;
            color: #FFF;
        }
        
        .items-collection1 label.btn-default {
            width: 10%;
            border: 1px solid #305891;
            margin: 0;
            padding-right: 0px;
            border-radius: 17px;
            color: #305891;
            opacity: 0.5
        }
        
        .items-collection label .itemcontent {
            width: 100%;
        }
        
        .items-collection .btn-group {
            width: 100%;
            padding-left: 45px
        }
        
        #tweetsbox {
			top: 0;
            background-color: rgba(52, 152, 219, 0.2);
            height: 100px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 70%;
        }

        .btn {
            height: 30px;
            position: absolute;
            right: 0;
            top: 5px;
            border-radius: 1px;
        }

        .topList {
          background-color: white;
          font-size: 1.2em;
          color: black;
          list-style-position: inside;
        }
        .ListTitle {
          font-size: 1.5em;
        }
    </style>
</head>

<body>

    <div id='map'></div>
    <div style="position: absolute; right: 0; width: 30%;">
      <div class="ListTitle">Top 10 Hashtag</div>
      <ol id="hashTopList" class="topList"></ol>
      <div class="ListTitle">Top 10 Mention</div>
      <ol id="mentionTopList" class="topList"></ol>
    </div>
	
	<div class='row'>
		<div class="small-6 columns small-centered">
			<div class="alert alert-info" id="tweetsbox"><span>Real-Time Tweets</span>
			</div>
		</div>

		<div class="form-group">
			<div class="items-collection" id="message1">
				<div class="items-collection1">
					<div data-toggle="buttons" class="btn-group ">
						<label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3 " id="1">
							<div class="itemcontent">
								<input type="radio" name="options" id="option1" autocomplete="off">Hashtop1
							</div>
						</label>

						<label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3" id="2">
							<div class="itemcontent">
								<input type="radio" name="options" id="option2" autocomplete="off">top2

							</div>
						</label>

						<label class="btn btn-default col-xs-2 col-sm-4 col-md-3 col-lg-3" id="3">
							<div class="itemcontent">
								<input type="radio" name="options" id="option3" autocomplete="off">top3

							</div>
						</label>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		jQuery(function ($) {
            //Global variables
			var socket = io.connect();
			var $tweetsbox = $('#tweetsbox');
			var hashRank = []; //descending sorted array with every element like [key, value] (sorted by value)
			var mentionRank = []; //descending sorted array ...
			var lastHashData = new Map(); // [key,value] value is set of coords
			var lastMentionData = new Map();

            //functions definition
			function genGeoTweet(tweet) {
				return {
					"type": "Feature", 
                    "geometry": {
						"type": "Point", 
                        "coordinates": tweet.coord
					}, 
                    "properties": {
						"text": tweet.text
					}
				}
			}

			function genGeoTweets(tweetPoints) {
				points = {
					"type": "FeatureCollection", 
                    "features": tweetPoints
				}
				return points;
			}

			function keyLocSetToGeoArray(key, locations) {
                var geoLocs = [];
			    for (var i = 0; i < locations.length; i++) {
                    var dummyTweet = {
                        "coord": locations[i],
                        "text": key
                    }
                    geoLocs.push(genGeoTweet(dummyTweet));
                }
                return geoLocs;
			}

			function registerLayer(name, color, docluster, opacity) {
				map.addSource(name, {
					"type": "geojson", 
                    "data": genGeoTweets([]), 
                    cluster: docluster, 
                    clusterMaxZoom: 40, // Max zoom to cluster points on
					clusterRadius: 50
				});

				map.addLayer({
					"id": name, // "interactive": true,
					"type": "circle", 
                    "source": name,
                    "paint": {
						"circle-color": color,
                        "circle-radius": 3,
                        "circle-opacity": opacity
					}
				});
			}

			function showPoints(tweets) {
				ChangeLayerLastData("marker_all", tweets);
			}

			function hideLayer(layer) {
				ChangeLayerLastData(layer, []);
			}

			function showPoint(tweet) {
				tweets_temp.push(tweet);
				ChangeLayerData("marker_temp", tweets_temp);
				var cur_point = "marker_point" + point_count;
				++point_count;
				registerTempLayer(cur_point, "lightblue");
				ChangeLayerData(cur_point, [tweet]);
				animatePoint(cur_point, Date.now());
			}

			function animatePoint(id, start_time) {
				var cur_frame = Math.floor((Date.now() - start_time) / 200);
				if (cur_frame <= 3) {
					map.setPaintProperty(id, "circle-radius", animation[cur_frame][0]);
					map.setPaintProperty(id, "circle-opacity", animation[cur_frame][1]);
					requestAnimationFrame(function () {
						animatePoint(id, start_time);
					});
				} else {
					map.removeSource(id);
					map.removeLayer(id);
				}
			}

			function registerTempLayer(name, color) {
				map.addSource(name, {
					"type": "geojson", 
                    "data": genGeoTweets([])
				});
				map.addLayer({
					"id": name, // "interactive": true,
					"type": "circle", 
                    "source": name,
                    "paint": {
						"circle-color": color,
                        "circle-radius": 1,
                        "circle-opacity": 0.2
					}
				});
			}

			function ChangeLayerLastData(layer, tweets) {
				tweets = genGeoTweets(tweets);
				map.getSource(layer).setData(tweets);
			}

			function ChangeLayerData(layer, tweetPoints) {
				tweets = genGeoTweets(tweetPoints);
				map.getSource(layer).setData(tweets);
			}
			
			function serveData() {
                for (var i = 0; i < 10; i++) {
                    var layer = "marker_" + i;
                    var key = hashRank[i][0];
                    ChangeLayerLastData(layer, keyLocSetToGeoArray(key, lastHashData.get(key)));
                }
				for (var i = 0; i < 10; i++) {
                    var layer = "mention_" + i;
                    var key = mentionRank[i][0];
                    ChangeLayerLastData(layer, keyLocSetToGeoArray(key, lastMentionData.get(key)));
                }
				//ChangeLayerLastData("restword", restKeyword);
			}

			function refreshPastData() {
				socket.emit('past data');
			}

			var refreshId = setInterval(refreshPastData, 60000);

			function displayMsg(data) {
				$tweetsbox.html('<span class="msg"><b>' + data.user + ': </b>' + data.text + ' ' + "</span><br/>");
			}

			socket.on('past data', function (data) {
				var hashRankNsort = {};
				var mentionRankNsort = {};
				lastHashData.clear();
				lastMentionData.clear();

				for (var i = 0; i < data.length; i++) {
					var property = data[i].properties.keyword;
					if (data[i].properties.type == "mention") {
						if (mentionRankNsort[property] === undefined) {
							mentionRankNsort[property] = 1;
						} else {
							mentionRankNsort[property]++;
						}
						//map
						var locs = [];
						if (lastMentionData.has(property)) {
							locs = lastMentionData.get(property);
						}
						locs.push(data[i].geometry.coordinates);
						lastMentionData.set(property, locs);
					} else {
						if (hashRankNsort[property] === undefined) {
							hashRankNsort[property] = 1;
							hashRankNsort[property] = 1;
						} else {
							hashRankNsort[property]++;
						}
						//map
						var locs = [];
						if (lastHashData.has(property)) {
							locs = lastHashData.get(property);
						}
						locs.push(data[i].geometry.coordinates);
						lastHashData.set(property, locs)
					}
				}
				hashRank = [];
				mentionRank = [];
				for (var key in hashRankNsort) {
					hashRank.push([key, hashRankNsort[key]]);
				}
				hashRank.sort(function (a, b) {
					return b[1] - a[1]
				});

				for (var key in mentionRankNsort) {
					mentionRank.push([key, mentionRankNsort[key]]);
				}
				mentionRank.sort(function (a, b) {
					return b[1] - a[1]
				});

				var ul = document.getElementById("hashTopList");
				if(ul.childNodes.length == 0){
				  for(var i = 0; i < hashRank.length && i < 10; i++) {
					li = document.createElement("li");
					ul.appendChild(li);
				  }
				}
				for(var i = 0; i < hashRank.length && i < 10; i++) {
				  var li = ul.childNodes[i];
				  li.innerText = hashRank[i][0] + ' : ' + hashRank[i][1];
				}

				var ul = document.getElementById("mentionTopList");
				if(ul.childNodes.length == 0){
				  for(var i = 0; i < mentionRank.length && i < 10; i++){
					li = document.createElement("li");
					ul.appendChild(li);
				  }
				}
				for(var i = 0; i < mentionRank.length && i < 10; i ++){
				  var li = ul.childNodes[i];
				  li.innerText = mentionRank[i][0] + ' : ' + mentionRank[i][1];
				}
				serveData();
			});

			var tweets_temp = []; // Records data for real-time tweets
			var map;
			var point_count = 0;
			var animation = [[1, 0.5], [20, 1], [50, 0.5], [100, 0]];

			$(document).ready(function () {
				mapboxgl.accessToken = 'pk.eyJ1Ijoid2Vpc2hpIiwiYSI6ImNpbmc5cHV4bzFnOHJ1Zmx3ZGxpaGU0aGIifQ.L20RZ709ePgurmOeOYPwXg';
				map = new mapboxgl.Map({
					container: 'map'
					, style: 'mapbox://styles/mapbox/dark-v8'
					, center: [-73.961425, 40.786338]
					, zoom: 11.7
				});
				//here you try to ask the user position then setView to map

				map.on('style.load', function () {
					registerTempLayer("marker_temp", "lightblue");
					registerLayer("marker_0", "#c84337", false, 0.9);
					registerLayer("marker_1", "#ca7f35", false, 0.9);
					registerLayer("marker_2", "#d9be26", false, 0.9);
					registerLayer("marker_3", "#a1be41", false, 0.8);
					registerLayer("marker_4", "#3cc382", false, 0.8);
					registerLayer("marker_5", "#3f88bf", false, 0.8);
					registerLayer("marker_6", "#3f88bf", false, 0.6);
					registerLayer("marker_7", "#3f88bf", false, 0.4);
					registerLayer("marker_8", "#3f88bf", false, 0.2);
					registerLayer("marker_9", "#3f88bf", false, 0.1);
					
					registerLayer("mention_0", "#c84337", false, 0.9);
					registerLayer("mention_1", "#ca7f35", false, 0.9);
					registerLayer("mention_2", "#d9be26", false, 0.9);
					registerLayer("mention_3", "#a1be41", false, 0.8);
					registerLayer("mention_4", "#3cc382", false, 0.8);
					registerLayer("mention_5", "#3f88bf", false, 0.8);
					registerLayer("mention_6", "#3f88bf", false, 0.6);
					registerLayer("mention_7", "#3f88bf", false, 0.4);
					registerLayer("mention_8", "#3f88bf", false, 0.2);
					registerLayer("mention_9", "#3f88bf", false, 0.1);
					//registerLayer("restword", "white", false, 0.1);
					
                    refreshPastData();
				});
			});

			socket.on('new tweets', function (data) {
				displayMsg(data);
				showPoint(data.point);
                //console.log(data);
			});

			$("#message1 label.btn").on("click", function () {
				if ($(this).attr('id') == 1) {
					map.setLayoutProperty("marker_all", 'visibility', 'none');
				}
				if ($(this).attr('id') == 2) {
					map.setLayoutProperty("marker_all", 'visibility', 'visible');
				}
			});
		});
	</script>
</body>

</html>
